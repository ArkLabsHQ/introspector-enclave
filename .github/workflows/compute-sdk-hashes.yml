name: Compute SDK Hashes

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag version (e.g. v0.0.14)'
        required: true

permissions:
  contents: write

jobs:
  compute-hashes:
    runs-on: ubuntu-latest
    steps:
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "rev=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "rev=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.rev }}
          fetch-depth: 0

      - name: Check if already computed
        id: check
        run: |
          REV="${{ steps.version.outputs.rev }}"
          if [ -f sdk-hashes.json ]; then
            FILE_REV=$(jq -r '.rev' sdk-hashes.json)
            if [ "$FILE_REV" = "$REV" ]; then
              echo "sdk-hashes.json already has rev=${REV}, skipping."
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - uses: cachix/install-nix-action@v27
        if: steps.check.outputs.skip != 'true'
        with:
          nix_path: nixpkgs=channel:nixos-25.05
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Compute vendor hash
        if: steps.check.outputs.skip != 'true'
        id: vendor
        run: |
          cd sdk
          OUTPUT=$(nix build --impure \
            --extra-experimental-features 'nix-command flakes' \
            --expr '
              let pkgs = import <nixpkgs> {};
              in pkgs.buildGoModule {
                pname = "enclave-supervisor";
                version = "dev";
                src = ./.;
                subPackages = ["cmd/enclave-supervisor"];
                vendorHash = "";
                doCheck = false;
              }
            ' 2>&1 || true)
          VENDOR_HASH=$(echo "$OUTPUT" | grep 'got:' | awk '{print $2}')
          if [ -z "$VENDOR_HASH" ]; then
            echo "::error::Could not extract vendor hash from nix build output"
            echo "$OUTPUT" | tail -30
            exit 1
          fi
          echo "vendor_hash=${VENDOR_HASH}" >> "$GITHUB_OUTPUT"
          echo "Vendor hash: ${VENDOR_HASH}"

      - name: Compute source hash
        if: steps.check.outputs.skip != 'true'
        id: source
        run: |
          TMPDIR=$(mktemp -d)
          git archive --format=tar.gz --prefix=source/ HEAD | tar xz -C "$TMPDIR"
          SOURCE_HASH=$(nix hash path "$TMPDIR/source")
          rm -rf "$TMPDIR"
          echo "hash=${SOURCE_HASH}" >> "$GITHUB_OUTPUT"
          echo "Source hash: ${SOURCE_HASH}"

      - name: Update sdk-hashes.json
        if: steps.check.outputs.skip != 'true'
        run: |
          REV="${{ steps.version.outputs.rev }}"
          jq -n \
            --arg rev "$REV" \
            --arg hash "${{ steps.source.outputs.hash }}" \
            --arg vendor_hash "${{ steps.vendor.outputs.vendor_hash }}" \
            '{rev: $rev, hash: $hash, vendor_hash: $vendor_hash}' > sdk-hashes.json
          echo "Updated sdk-hashes.json:"
          cat sdk-hashes.json

      - name: Commit and update tag
        if: steps.check.outputs.skip != 'true'
        run: |
          REV="${{ steps.version.outputs.rev }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sdk-hashes.json
          git commit -m "sdk hashes for ${REV}"
          git tag -f "${REV}"
          git push origin HEAD:master
          git push origin -f "refs/tags/${REV}"
          echo "Pushed updated sdk-hashes.json and re-tagged ${REV}"
